スポットライトエフェクト Ver.2.0

製作：そぼろ

MMDの光源の自由度を高めるスポットライトのエフェクトです。
独自処理により複数シャドウ＆ソフトシャドウを実現しています。

基本的な仕組みとしては、MMD標準の描画結果に
スポットライトの光による描画結果を加算合成していく形になっています。
ハレーションを引き起こしやすいので光の強度には十分ご注意ください。

Si値で光の放射角度、Tr値で光の強度を操作可能です。

また、オプションのエフェクト、モデル、アクセサリを併用することでより便利に
エフェクトを使うことができます。詳細は各項目をご覧ください。

舞力介入Pのfull.fx、データPのSubCamera.fx、
Furia氏の異方性フィルタエフェクトを参考にさせていただきました。


■■ 必要環境 ■■

・MME 0.23以降
・シェーダモデル3.0および浮動小数点テクスチャをサポートするグラフィックボード
・.NET Framework 2.0

MMEの制限と、速度より汎用性を重視した結果、激烈に重くなってしまいました。
特に、シャドウありで複数同時使用する場合グラフィックメモリを大量消費するので
現行世代のミドルクラス以上のグラボが推奨されます。


■■ 更新履歴 ■■

□Ver.2.0
エフェクト本体
・シャドウありとなしで名前を分けるのを廃止
・テクスチャの異方性フィルタリングに対応
・SpotLightPowerCenterの近くで影がシャープになる機能を廃止
　(パフォーマンスコストが大きすぎるため)
・影が不自然に透ける場合があるのを修正
・影部分でスフィアマップが適用されないバグ修正
・複数読み込むとSpotLightModelがどんどん明るくなる不具合修正
・ソースコードの整理

ツール
・設定ファイルのドラッグ＆ドロップ対応
・設定ファイルの自動保存機能追加
・距離減衰を基本設定に移動
・設定項目の追加
・外部テンプレート対応

オプション
・SpotLightModelIK.pmd 追加
・SpotLightModel.pmd 微修正

□Ver.1.0
・公開開始


■■ 支援ツール　SpotLightGenerator.exe ■■

SpotLightエフェクトでは、エフェクト生成のための支援ツールが標準で付属しています。
初期状態ではエフェクト本体は同梱されていないため、まずはこのツールでエフェクトを
作成するところからはじめます。

このエフェクトは多くのパラメータが複数のファイルに分散し、手動での編集は
非常に煩雑になるため推奨しません。


●パラメータ

次のようなパラメータ調整ができます。

□基本設定

・独自セルフシャドウ
そのスポットライトが影を作るかどうか選択します。
オンとオフでエフェクトファイルの中身が大幅に変わります。

・ID
エフェクトの番号を指定します。SpotLight(ID).fxのようなファイル名で作成されます。
エフェクト内部でもこのIDが使用されているので、安易にファイル名を変更しないでください。
基本的に同じIDのエフェクトを複数読み込んではなりません。
5文字までの半角英数が使用できます。

・ライト色
ライトの色を指定します。MMDのライト色と同じような感覚で指定できます。

・ライト最大強度
ライトの発光強度の最大値を指定します。
1にすると、MMD距離20程度の位置でMMD標準ライトと同じぐらいの
明るさになります。（距離減衰ありの場合）

Tr値で強度の調整を行う関係上、MMD上からでは最大強度を超える強度には
できないので、最大強度は大きめにしてTr値で小さく調整した方が
柔軟に運用できます。

・モデル影色
独自セルフシャドウ オンでのみ有効です。
PMDモデルに落ちる影の色を指定します。
MMDの地面影色と同じような感覚です。
1でMMD標準と同程度です。

・アクセサリ影色
独自セルフシャドウ オンでのみ有効です。
アクセサリに落ちる影の色を指定します。

・距離減衰
距離に応じて光が弱まっていく度合いを指定します。
なし、距離に反比例、距離の2乗に反比例の3種を選べます。
物理的に正しいのは距離の2乗に反比例ですが、極端なライティングになるので
逆に不自然にもなりやすいです。
距離に反比例でもそれっぽく見えますし、広範囲を照らしたいときなどはOFFが適しています。


□詳細設定

・ソフトシャドウ
影のエッジをやわらかくします。
オフにすると、MMD標準と同じような1/0判定の影になります。

・テクスチャシャドウ
オンにすると、テクスチャの透明部分を透過した影が生成されます。
オフならばポリゴン形状の影になります。
オフのほうが若干軽いです。

・影アルファ抜き閾値
テクスチャシャドウが有効な時、
アルファ値がこの値より小さい部分は影を落とさなくなります。


・シャドウバッファ・ミップマップ使用
グラボのミップマップ機能を利用して、より広範囲のぼかしを行います。
古いグラボで、影の境界に不自然な縞が現れる場合、
ミップマップに対応していないと思われるのでオフにしてください。
また、ある程度シャープな影がほしい場合もオフにできます。

・シャドウバッファ・アンチエイリアス
シャドウバッファの描画にアンチエイリアスを適用します。
セルフシャドウ精度が大きく向上しますが、
グラボのパワーに余裕があり、より高品位な影を求められる場合にのみ
オンにしてください。
当然、アンチエイリアスが使えない環境では意味を持ちません。

・シャドウバッファサイズ
独自セルフシャドウに使用するZバッファのサイズを指定します。
大きくするとセルフシャドウの精度が向上しますが重くなります
細いスポットしか使用しない場合は、小さくすることでパフォーマンスの向上が望めます。

・除外モデル
スポットライトによる描画の対象としないモデルやアクセサリの
ファイル名を指定します。セミコロン";"で区切って複数指定可能です。
他のポストエフェクトのダミーアクセサリなどを指定します。
このパラメータを変更して上書き保存しても
MMEの自動更新の対象とならないことがあります。


・異方性フィルタリング
Furia氏の異方性フィルタエフェクトを組み込んだ機能を有効にするかどうか選択します。
遠くのディテールがアップ＆モアレ軽減が見込めます。
MMD標準の描画結果には影響しないので、SpotLightMasterControlで完全に隠すか
Furia氏のエフェクトを使ってMMD標準の描画にも異方性フィルタリングを適用してください。
この機能はハードウェアが対応している必要があります。



●設定保存
エフェクトが複数ファイルに分散している関係上、作成したエフェクトからパラメータを読み直すことが
困難なため、独自の設定ファイル（SLGSファイル・中身はXML）に頼っています。
右上のボタンから保存と読込が可能で、ドラッグ＆ドロップにも対応しました。
また、「設定ファイルの自動保存」がオンになっていると、
エフェクトファイルと同名の設定ファイルが自動的に作成されます。


●初期値の変更

各パラメータの初期値を変更するには、SpotLightGenerator.exeと同じフォルダに
"default.slgs" という名前で設定保存してください。
また、このファイルを削除すれば初期値はリセットされます。


●外部テンプレート読み込み・上級者向け

生成されるエフェクトの、パラメータ以外の部分を変更したいという場合は
テンプレートを外部に用意することでそちらからエフェクト生成が可能です。
templateフォルダを作成し、そこに各エフェクトのテンプレートを入れておくことで
そちらを優先して読み込みます。テンプレートが見つからなければ内部リソースを使用します。
テンプレートにはパラメータの代わりに<<ID>>のようなタグが埋め込まれています。
これらのタグはエフェクト生成時に単純置換されます。
標準のテンプレートは別途配布しています。



■■ メインエフェクトファイル ■■


●SpotLight.fx

最も基本となるエフェクトです。
MMD標準の描画結果に、SpotLight_Object.fx を使って描画した結果を加算合成します。

SpotLight.xをMMDに読み込み、描画順を一番最初にした上で、
ダミーボーンなどに取り付けて自由に移動させて使います。

Si値で光の放射角度、Tr値で光の強度を操作可能です。


●SpotLight_Object.fx

SpotLight.fx から呼び出され、各モデルを描画するエフェクトです。
ユーザーがMMDに読み込む必要はありませんが、パラメータの多くはこちらにあります。


●SpotLight_ShadowZBuf.fx

独自セルフシャドウ用のZバッファを作成するためのエフェクトです。
独自セルフシャドウがオフの場合は必要とされません。


●CommonSystem.fx

Object系のエフェクトで使われる共通部分をまとめたファイルです。
改造以外では、編集の必要はありません。


●SpotDist.bmp

スポットライトの発光強度分布を指定するテクスチャです。
上がスポット中心、下が外側になります。

このテクスチャを差し替えることで発光パターンを変更できます。
最下段は必ず黒にしてください。



■■ オプション ■■

オプションのエフェクト、モデル、アクセサリなどです。
「Options」フォルダに入っています。
エフェクトの動作に必須ではありませんが、使うとたいへん便利になります。


●SpotLightModel.x

スポットライトの形状をした、ただのアクセサリです。
SpotLight.xは不可視で、どの方向を向いているかわかりにくいので、
同じダミーボーンにこのアクセサリを取り付けることで操作しやすくなります。
適当に自作したので、デザインが気に入らなければ適宜差し替えてください。

●SpotLightModel.pmd

上のアクセサリに独自のダミーボーンを仕込んだものです。
「本体」ボーンに SpotLight.x を取り付けることを想定しています。
このモデルの使用/不使用はエフェクトの動作には影響を与えません。
好みにカスタマイズしてもかまいません。

●SpotLightModelIK.pmd

ボーンにIKを使用したバージョンです。
照射先ボーンを移動させると自動的に向きが変わります。
2つのボーンの移動だけで操作できるのでお手軽です。

●SpotLightPowerCenter.x

このアクセサリを読み込むと、距離減衰ありのスポットライトにおいて、
このアクセサリの位置での光強度が一定となるように自動的に発光強度が調整されます。
主役モデルの頭などに取り付けておくと、モデルが移動しても、またはライトが移動しても、
明るさを一定に保つことができます。

アルファ値を0にして使用してください。


●SpotLightMasterControl.fx

MMD標準の描画結果を暗くし、ライトの当たっていない部分の
アンビエント光を弱める効果があります。
Tr値を小さくするとその効果は薄れます。
Si値を小さくすると、すべてのライトの強度も同時に落ちるので、
カメラの絞り調整として利用できます。

描画順の最後に指定します。
BlackOut.fxと同じ仕組みを用いています。


■■ セルフシャドウ詳細 ■■

このエフェクトには独自処理によるセルフシャドウが搭載されています。
エフェクトごとに個別のシャドウが描かれるので、複数エフェクトを併用することで
複数のシャドウを描くことができます。

MMD本体のセルフシャドウとの併用も可能ですが、質感を合わせるのが難しく
違和感が出やすいため、地面影およびセルフシャドウは基本的にOFFにして使います。

またこのエフェクトには、VSM法によるソフトシャドウ機能が搭載されています。
シャドウの境界をぼかし、自然に見せる効果と、ジャギーを目立たなくする効果があります。

ソフトシャドウをOFFにして、MMD標準と同じようなシャドウの描画も可能です。
ただし、LSPSM法を実装していないため、精度は良くありません。
利点として、視点の移動で影が揺らぐことがないとい点が一応あります。

光の放射角度を大きくするとセルフシャドウの精度は低下し、その分ぼかしが強くなります。
ソフトシャドウが有効な状態であっても Si = 3 程度が実用上の限界と思われます。

ジャギーが気になり、かつマシンパワーに余裕があるときは、シャドウバッファサイズを
大きくすることで、より高精度な影が描かれるようになります。


■■ 試し方 ■■

ひととおりの機能を試す手順の一例です

・SpotLightGenerator.exe を起動
・初期値のまま、出力ボタンをクリック
・MMDを起動し、生成された SpotLight1.x をドラッグ＆ドロップ
　エラーが出ず、背景が黒くなればおそらく正常に動作しています
・Optionsフォルダの SpoitLightModel.pmd を読み込み
・SpotLight1.x を、SpoitLightModel.pmd の「本体」ボーンにアタッチ
・SpotLight1.x のTr値を0.5に設定
・初音ミクVer2.pmd を読み込み
　ここで上半身を中心に明るく照らされていればほぼ成功です
・MMDのセルフシャドウ、地面影をオフに。また情報表示ON推奨。
・MMDの照明を最低値まで落とす
・stage01.x を読み込み、ステージに影が写り込むことを確認
・SpoitLightModel.pmd を操作し、スポットライトの位置や向きを変えてみる
・SpotLight1.x のTr値やSi値をいじってみる
・Optionsフォルダの SpotLightPowerCenter.x を読み込み、
　初音ミクVer2.pmd の頭にアタッチしてみる
・SpotLightMasterControl.x を読み込み、Tr値やSi値をいじってみる
・SpotLightGenerator.exe の各種パラメータをいじって、上書きしてみる

※SpotLight1.x の描画順は最初にしてください
※SpotLightMasterControl.x の描画順は最後にしてください


■■ 制限 ■■

モデル描画は、他のエフェクトがかかっていない状態をベースにして行われます。
そのため、Mirror.fxでの鏡像や、Clone.fxで増殖させたモデルを照らすことは
基本的にできません。
ただし、Object系のエフェクトを自前で改造できるのであればその限りではないかもしれません。


■■ 免責 ■■

改造・再配布は自由ですが、自己責任でお願いします。
また、このエフェクトを使用した結果についての責任は負いかねます。

