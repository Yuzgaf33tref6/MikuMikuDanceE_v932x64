
ikボケ


■ 概要

	このドキュメントは、MikuMikuEffect用エフェクト「ikボケ」の使い方を説明するものです。
	ikボケとは、ポストエフェクトによって、カメラの被写界深度(DoF: Depth of Field)を擬似的に表現するエフェクトです。

	設定の値は現実のカメラっぽいものを使用していますが、実際の各数値の扱いは適当になっています。
	光学的な正しさはまったく保障していません。

	動作は非常に重いです。


■ 使用方法

1. MMDのアクセサリに、"ikボケ.x"を追加してください。

2.SSAOなどよりは後に設定してください。
	アクセサリの描画順序によって、結果が異なります。
	色調補正系のエフェクトは好みでよいかと思われます。
		明るさ(=色)がボケ度合いを決めることがあるため、順番を変えると見た目が変わる可能性があります。

3.各種パラメータを設定します。(詳細は後述します)
	Ry に 50を
	Rz に 3を
	Si に目標までの距離を入力します。

	とにかくボケボケにしたい場合は、
	Ry に 100 (大きい数値)を
	Rz に 2 (小さい数値)を
	Si に 30付近の値 (小さい数値) を設定したあと、カメラを目標に近づけてください。

	逆にボカしたくない場合は、
	Ry に 30、 Rz に 5、(Siは任意) を入れれば、大体ピントが合うようになります。


■ ファイルの内容

	DbgNumber.png			デバッグ表示用のテクスチャ
	ikDepthBright.fx		前処理用の深度と明度を記録するエフェクトファイル
	ikボケ.fx				ボケエフェクト本体のエフェクトファイル
	ikボケ.x				MMDで被写界深度を表現するためのMMEポストエフェクト
	readme.txt				このファイル


■ パラメータの詳細

□ アクセサリ上から設定できるパラメータ

	Si ： ピント位置
		MMD単位によるピントまでの距離を設定してください。
		カメラを対象に近づけたほう(=ピント位置を小さくする)がボケやすくなります。

	Ry : 焦点距離
		カメラの焦点距離を設定します。
		広角カメラなら 25、標準カメラなら 50、
		望遠ならば、100〜200を設定してください。
		望遠になるほど被写界深度が浅くなり、ボケやすくなります。

	Rz : 絞りの調整
		2〜10程度を設定してください。
		小さな数値ほど、ボケやすくなります。
		※ 絞りを変更しても画面の明度は変化しません。
		※ 絞りを変更することで、錯乱円(ボケ形状)の大きさは変化しますが、形状は変化しません。


	X : デバッグモード
		1を設定すると、調整用のデバッグモードになります。
		白い領域が被写界深度内(ピントが合う位置)、
		紫の領域が前ボケ範囲、緑の領域が後ボケ範囲になります。

		画面右上の数字は設定から導き出される画角値になります。
		※ 現実のカメラではピントと焦点距離を変えると画角も換わります。
		この数値そのまま使う必要はありませんが、ピント変更に合わせて、カメラの画角も変更するとよりソレらしくなります。

		2行目に表示する値は、ピント位置になります。Si値を10倍した値が表示されます。


□ エフェクトファイル上で直接操作するパラメータ

ikボケ.fx

	※ Ver0.01にあった、絞り形状の設定はなくなりました。

	SAMPLING_STEP
		ボカしを掛ける際の、読み込み幅。1または2を設定。
		1のほうが綺麗ですが、遅くなります。

	FORCE_COC_SCALE
		ボケのサイズを強制的に拡大する、拡大率。
		デフォルトは1(等倍)

	ENABLE_TEST_MODE
		テストモード有効設定。1で有効。
		アクセサリのXに1を入れると、テストモードで表示されます。

	DISABLE_ALL
		ボケエフェクト全体をカットする機能。
		モーション調整中などで邪魔なとき用に追加。

	AF_MODEL_NAME
	AF_NODE_NAME
		自動追従用のターゲット
		アクセサリに追従させる場合はモデル名のみを指定する。
		自動追従させたくない場合は、両方コメントアウトする(行頭に//をつける)。

		モデルの頭ボーンに追従させた場合、ボーン位置と顔表面の位置に差があるため、
		被写界深度によってはピントが合いません。実際にピントを合わせたい場所に
		ピント専用のアクセサリを置いて、それにピントを追従させるか、
		絞りなどの設定で被写界深度を深くするかして対処してください。


ikDepthBright.fx

	AlphaThroughThreshold
		テクスチャのアルファ値がこの値以下ならば無視されます。
		抜きテクスチャで不具合がでた場合、この値を調整することで改善する場合があります。

	EMPHASIS_BRIGHTNESS
		明るい部分の強調を行うかどうか。1で強調処理を行います。



■ よくある問題

	もっとボカしたい。
		Ry を 50〜200の大きな値にする。
		Rz を1〜3の小さい値にする。
		カメラを近づけて、Siを小さくする。

	もっとくっきりさせたい。
		Ry を 20〜50の小さい値にする。
		Rz を5〜8の大きな値にする。

		ikボケを表示にする。
			モデル調整時などはikボケを切ったほうが作業がしやすいです。

	被写界深度を狭めたい。
		Ry を大きくする。
		カメラを近づけて、Siを小さくする。

	被写界深度を広げたい。
		Ry を小さくする。
		カメラを離して、Siを大きくする。

	ボケる範囲が判らない。
		→ アクセサリのXに1を入れて、テストモードにする。
		ピントを合わせたい範囲が緑なら、Siを小さく。紫なら大きくする。
		まずは、MMDのカメラの距離をSiにいれれば、近い位置にピントが合うはず？カメラワークしだい。

	もっとボケの大きさを大きくしたい
		エフェクトファイル内のパラメータを弄る。
		出力画面サイズを小さくする。


■ 既知の問題

	前ボケとピントが合っている場所の境界がはっきりと判る。
	特に、オブジェクトが奥行き方向に伸びていて、ピントが合っている状態とあっていない状態を含む場合に、不自然に見える。


	エフェクトによって写り込んだ遠くのモデルが、反射された手前の距離でボケかされる。
	例：ボケた背景がピントのあった手前の床に写り込んでいる場合、床に合わせてピントが合った状態で表示される。

	手前にあるはずのパーティクルなどのエフェクトが遠くにあるかのようにボケる。
	パーティクル側と連携して個別に対応する必要があります。


■ 使用、再配布に関して

	エフェクトの利用、改造などについては自由に行ってもらってかまいません、連絡も不要です。

	このエフェクトを使用したことによって起きたすべての損害等について、作者及び関係者は一切責任を負わないものとします。


■ 更新履歴

	2014/11/09 Ver 0.06		32bit対応
	2014/11/07 Ver 0.05		自動フォーカス機能の追加
	2014/11/05 Ver 0.04		バグの修正と微調整
	2014/10/26 Ver 0.03		全面的に改造
	2014/09/04 Ver 0.02		ファイル名とreadme.txtの誤字修正
	2014/08/28 Ver 0.01		初公開


ikeno

