

ikSweat

	汗っぽいなにかを描画するエフェクトです。
	制限事項が多いです。激しく重いです。グラボによっては動作しないかも知れません。
	設定も面倒です。その割りに見た目は地味です…。


■ 使用方法

	(すでに、ikSweatを適用するモデルを読み込んであるものとします。)

	MMDのアクセサリに、"ikSweat.x"を追加してください。
		(何も弄っていなければ、Water1が適用されます。)

	MMEのエフェクト割り当てを開きます。

	WorldPosOnUV_RTタブ：
		すべて(none)が割り当てられているはずです。
		適用させたいモデルを選択し、サブセット展開、エフェクトを適用させたい材質にだけ、
		ikWorldPos.fxを割り当てます。

	UVPosOnScreen_RTタブ
		すべてikUVMapMask.fxが割り当てらているはずです。
		エフェクトなど表示する必要の無いものは、チェックをはずして描画対象からはずしてください。
		適用させたいモデルの材質に、ikUVMap.fxを割り当てます。

	これでエフェクトが適用されるはずです。


■ ファイルの内容

	readme.txt
		このファイル

	ikSweat.fx
		エフェクトのソース
		材質のプリセットの変更、エフェクト割り当てタブの名前を変更する場合に使用します。

	ikSweat.x
		エフェクト本体。これをMMDに投入してください。

	ikSweat2.fx
	ikSweat2.x
		ikSweat.fx, ikSweat.xを複製したもの。複数モデルに適用する場合に使用してください。

	ikSweat_water1.fx
	ikSweat_water2.fx
	ikSweat_choco.fx
	ikSweat_slime.fx
		プリセットの素材設定を行っているファイル。
		これを参考に値を調整してください。

	ikSweat_custom.fx
		MMDのアクセサリ操作からいくつかのパラメータを変更できるようにしたものです。


	ikSweatMain.fx
		エフェクトの実質的なメイン。
		シェーダーを直接弄りたい人意外は放置でいいです。

	ikUVMap.fx
	ikUVMapMask.fx
	ikWorldPos.fx
		エフェクト割り当てタブで設定するサブエフェクト。

	raindrops_volume.png
		水滴のテクスチャ。

	rand256.png
		乱数作成用のテクスチャ


■ 設定内容

ikSweat.fx
	素材設定 で includeするファイルを1つだけ選んでコメント(行頭の//)をはずしてください。

	MMEのタブ名。
		コメント通りです。ikSweat.fxとikSweat2.fxを見比べてください。
		判らなければ放置でよいです。


素材設定ファイル(ikSweat_water1.fxなど)
アクセサリからの設定。

	※ 素材設定ファイルだけを弄っても、反映されない場合があります。そのときは、ikSweat.fxに改行を入れる→戻す→保存するか、MMEから"全て更新"を選択してください。
	あるいは、ikSweat.fxで読み込んでいるファイルと別のファイルを弄っているかも知れません。確認してください。


	USE_PRESET
		プリセットの値を使うか、アクセサリのパラメータを使うか選びます。

	FallSpeedRate
	アクセサリのX (USE_PRESETが0の場合のみ有効。以下同様。)
		水滴の落下速度 (速過ぎると軌跡が途切れる)。1前後の値を推奨。

	Thickness
	アクセサリのY
		水滴の厚み (0.5〜4.0程度。大きいほど厚い)

	DryRate
	アクセサリのZ
		軌跡が乾く速度(1未満にすること。1に近過ぎると飽和してフラットになる。)
		小さいほど軌跡の長さが短くなります。0.8〜0.99を推奨。

	LifetimeScale
	アクセサリのRx
		落下までの時間のスケール値。
		水滴の落下時間を動画内で変更したいとき用。
		基本的には1にしておき、LifetimeMin、LifetimeFluctuationで時間を設定するだけで十分だと思われます。

	ParticleSize
	アクセサリのRy
		水滴の大きさ (0.5〜4.0 小さくし過ぎると軌跡が途切れる)

	アクセサリのSi
		水滴の使用量。0〜1

	MaterialAlpha
	アクセサリのTr
		水滴の半透明度


	LifetimeMin
	LifetimeFluctuation
		水滴が落下するまでの時間
		LifetimeMin x LifetimeScale 〜 (LifetimeMin+LifetimeFluctuation) x LifetimeScale までの間に落下する。

	DurationMin
	DurationFluctuation
		落下した水滴が消滅するまでの時間

	MaterialColor
		水滴の色。
		アルファは、MaterialAlphaかアクセサリのTr(USE_PRESETを指定しない場合)で設定します。

	AmbientPower
		水滴の光源計算で、光の影響をどれだけ弱くするか。

	Smoothness
		ハイライトの鋭さ：角度に対する反応の鋭さ
	SpecularScale
		ハイライトの強度：ハイライトの明るさ

	MaterialShadowColor
		水滴の影の色。モデルの色に依存。
		モデル自体から参照してもよかったのですが、これ以上重くなる＆設定が複雑になるのを避けるため、手抜きをしています。

	ShadowPower
		影の濃さ


	RESET_AT_START
		0フレ再生時に水滴を消すか? (0:消さない。1:消す)

	USE_MOTION
		モーションによる影響のOn/Off。モデルの動きに合わせて、水滴を動かすオプションです。
		重さの割りに微妙な効果なので、基本的にオフにしてあります。マシンパワーに余裕がある人は試してみてください。


■ 動かない場合

	表示されない場合
		MMDのメニュー、背景＞アクセサリ編集の、"***番目より後のアクセサリはモデル描写後に描写する」を確認する。ikSweatはモデルより後に描かれる必要があります。

	表示はされるが、落下しない場合。
		落下時間の設定を調べる。
			エフェクト内の LifetimeScale、LifetimeMin、LifetimeFluctuation の値。
			アクセサリのRx の値
			は適切か。

		USE_MOTIONがオンになっている場合、オフにしてみる。

		ikSweatMain.fx 冒頭の、TEXFORMATを "D3DFMT_A16B16G16R16F" から "D3DFMT_A32B32G32R32F" に変えてみる。
		ポリゴン密度が高い場合、D3DFMT_A16B16G16R16Fでは計算精度が足りない場合があります。


■ 制限事項

	スカイドームなどの背景を置かないと、モデルの輪郭からはみでた水滴が表示されない。
		背景を置いても、それがikSweatより後に描画していると、はみ出た分が塗りつぶされる。

	半透明なエフェクト類はこのエフェクトよりもあとに掛けたほうがいいかも。

	□ テクスチャ空間で描画しているため生じる制限

		別テクスチャに分かれているマテリアルを同時にエフェクト対象にできない。
			同一テクスチャであれば、上半身と下半身のように、別マテリアルに分かれていても同時にエフェクト適用可能。
			エフェクトを複製して、それぞれのテクスチャ用にエフェクトを適用すれば、同時に使用可能。ただし、両者の間で水滴の移動は発生しない。

		同一マテリアル内に、適用させたくないオブジェクトがあっても一緒に適用される。
			PMD,PMXレベルで材質を分離する。

		同一テクスチャを使っていても、他モデルとは共有できない。
			両者が異なる座標に存在するため。


		極端なテクスチャの貼られ方をされていると不具合が生じる。
			腕と足とで同じ領域を使用するとか。
				同一テクスチャ内の別々の領域に腕と足が混在するのは問題ない。

			8x8サイズの単色テクスチャをベタ貼りしてあるだけとか。

		テクスチャ密度が極端に違うとおかしくなる(かもしれない)。
			水滴の出現率はテクスチャに対して均等に割り振っているので、特定部位がテクスチャの大部分を占有すると、そこにだけ水滴が発生することになる。

			アンチエイリアスなどの各種処理をテクスチャ空間で行うため、テクスチャの密度の違いが影響する。

		UVの切れ目でグリッチが生じる。
		UVの切れ目部分で水滴の移動が上手くいかない場合がある。
			特に画面外に出ている場合、移動が出来ない。
			このため、急にカメラに入ってきた部位のUVの切れ目で、水滴の有無がはっきり分かれる場合がある。


■ 使用、再配布に関して

	エフェクトの利用、改造、再配布などについては自由に行ってもらってかまいません、連絡も不要です。

	このエフェクトを使用したことによって起きたすべての損害等について、作者及び関係者は一切責任を負わないものとします。



■ 更新履歴

	2014/10/10 Ver.0.02		不具合対応
			同一パスで書き込み対象のテクスチャを参照できない場合があるとのことなので、一度バッファに退避するようにした。ご指摘いただいたビームマンさんに感謝します。

	2014/10/03 Ver.0.01		初公開


ikeno
