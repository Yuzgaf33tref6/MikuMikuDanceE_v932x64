
なんとなく水中っぽくするエフェクト


■ 概要

床にコースティクスを表示するエフェクト。
コースティクスは、コップに入った水やレンズで光が集まる現象。
水面が波打っているために、水底に映るコースティクスはユラユラと揺れる。

ついでにゴッドレイとか水面も表示したりする。
水面はおまけ程度のクオリティです。



■ 使用方法

1. MMDに ikUWController.pmx と ikUnderwater.x を入れる。
　※ ikUnderwater.x の読み込みは非常に時間が掛かります。

2. ikUWController.pmxを適当な高さまで持ち上げる。
　これが水面の高さになる。

3. 表情モーフの左上(目)から、ライトR,G,Bに適当な値を設定する。
　たとえば、RGBそれぞれに0.1, 0.4, 1.0。
　これがゴッドレイとコースティクスの色になる。

4. ikUWController.pmxの位置や向きを変えてみる。
　ikUWController.pmxを起点にY軸方向から光が差す。

5. 3.同様に、フォグ明度、フォグR,G,Bに適当な値を設定する。
　たとえば、フォグ明度に1.0、フォグR,G,Bに0.0, 0.2, 1.0。
　これが水中全体の色になる。
　別のフォグエフェクトを利用してもよい。

6. MMDのライトの色も必要に応じて青っぽくする。
　ライトの向きは ikUWController.pmx とあわせてもよいし、あわせなくてもよい。

7. 描画順の設定。基本的には、パーティクル類 > ikUnderwater > 色調補正系の順に出力するのがよい。
　何かを描画するエフェクトとの相性は悪い。

8. MMEタブで余計なものを外す。
　LightSpaceDepth, 
　CameraSpaceDepth,
　ReflectionMap,
　RefractionMap から半透明なもの、他のエフェクトなどを除外する。
　※なぞの四角いものが表示されたり、エフェクトが部分的に効かないという症状が起きなければ何もしなくてよい。

9. 表情モーフのその他の項目を適当に弄る。

10. settings.fxsubの内容を必要に応じて弄る。



■ 表情モーフの設定項目

大抵の表情モーフは0でデフォルト値が適用されるようになっている。
このため、0.000と0.001のあいだで設定が大きく変化するものがある。


・ライト距離、角度
　ゴッドレイとコースティクスの範囲を指定する。
・ライトR,G,B
　ゴッドレイとコースティクスの色を指定する。
・フォグR,G,B、フォグ明度
　水中フォグの色を指定する。
　明度を下げると、遠くが暗くなる。

・ゴッドレイ強度、コースティクス強度
　それぞれの明るさを指定。
・スペキュラ強度
　水面のハイライトの強さを指定
・フォグ強度
　水中フォグの強さを指定。大きいほどカメラ近くでもフォグの影響を受ける。
・深度フォグ強度
　水深が深くなるほど暗くなるフォグの強さを指定。

・波の密度
　波紋の広がり具合を指定
・波の速度
　フレーム当たりの変化量を指定
・波高
　波の高さを指定。
　水面の見た目にだけ影響して、コースティクスやゴッドレイには影響しない。

・エフェクト強度
　エフェクト全体の強度を指定。



■ settings.fxsubの設定項目

MMD実行中にsettings.fxsubを書き換えても自動で適用されない。
MMEffectから"全て更新"を選択する。

各項目については settings.fxsub 内のコメントも参考にする。


□ ゴッドレイに関するもの

RayMarchCount
　ピクセルあたりの探索回数。増やすほどゴッドレイは正確になるが、実行中の重さと読み込み時の重さが増加する。64以上にしても効果は上がらない。

FOG_BUFFER_SCALE
　ゴッドレイ計算用ワークのサイズ。大きい値ほど、ゴッドレイがボヤける。小さいほどくっきりするが、重くなる。


□ 水面に関するもの

ENABLE_WATERPLANE
　これを0にすると水面を完全に処理しない。
　深海などで水面が不要な場合は0にする。

ENABLE_REFRACTION_MAP
　これを0にすると、通常の画面を利用して水面による屈折を行う。
　1だと専用の画面を別途作成する。

　0の場合、水中から水上を見上げる場合に、本来、水上のものが見える状況で、水中のものが映りこんでしまうことがある。波が高い場合などは気にならない。


ENABLE_REFRACTION_EFFECT
　0の場合、水面画像の合成後にまとめてエフェクトを掛ける。
　1の場合、屈折用ワーク画面に独立して水中エフェクトを適用してから合成する。

　0の場合、水上から水中を見た場合に、ゴッドレイやコースティクスが波の影響を受けない。
　水上から水面を見ない場合は0でよい。


DISTORTION_BUFFER_SCALE
　水面を合成した結果描画を格納するサイズ。大きいほど軽くなるが、水面がボケる。

REFLECTION_BUFFER_SCALE
　反射や屈折するものを描画するサイズ。大きいほど軽くなる。



■ 既知の問題

・半透明な材質は正しく扱えない。
　半透明な材質に対して水中フォグが無視される場合、LinearDepth.fx内の
　ShadowAlphaThresholdの値を小さくしてみる。
　個別に調整したい場合は、LinearDepth.fxを複製して、ShadowAlphaThresholdを変更。
　新しく作った、LinearDepth.fxを調整したい材質に割り当てる。

　半透明なオブジェクトのせいで、その奥のオブジェクトのフォグが不自然になる場合、
　LightSpaceDepth, CameraSpaceDepthなどから、半透明なオブジェクトを除外する。

・水上から見たとき、水面との境界が汚い。

・他の描画系エフェクトと相性が悪い。

・カメラが水上から水中、その逆に移動したときに変なものが見える(ことがある)。
　カメラが水面と水平になると水面に不具合が出やすいです。
　カメラを素早く動かす。泡とかでごまかす。

・フォグの色設定が面倒くさい
　フォグR,G,B,明度、フォグ強度、MMDのライト色で設定する必要がある。
　色調補正系のエフェクトを使ったり、動画編集時に色調補正するほうが簡単かも。

・その他全般、設定が面倒くさい。



■ 使用、再配布に関して
エフェクトの利用、改造などについては自由に行ってもらってかまいません、連絡も不要です。

このエフェクトを使用したことによって起きたすべての損害等について、
作者及び関係者は一切責任を負わないものとします。



■ 更新履歴

2016/04/17　ver.0.03　ゴッドレイが出ないバグを修正。
2015/07/11　ver.0.02　水中フォグの扱いを直感的にした。
　　　　　　　　　　　DoF用の水面深度の出力が間違っていたので修正。
2015/07/02　ver.0.01　初公開


ikeno
twitter: @ikeno_mmd

