
ikVXGI

■ 概要

このエフェクトはブロック状(ボクセル)に変換したモデルを利用して光の反射を計算します。
VXGIはたぶん、VoXel Global Illuminationの略。

※ 実験的なもので実用性はありません。既知の不具合の節を読んでから使用を検討してください。


■ 既知の不具合

重い
　ポリゴン数が多いほど重くなります。

汚い
　仕様です。いろいろ計算を端折っているため。

　・ちらつく
　　モデルが動くことで、ボクセルがオンになったりオフになったりするため。

　・薄い壁、隙間から光が漏れる。
　　壁の表裏チェックが緩いため、壁の裏側が光に当たっていると、壁の表側にも光が漏れます。
　　また、壁のつなぎ目から光が漏れることがあります。

　　対策：
　　　VoxelPackRTタブでだけ有効なダミーのポリゴンモデルを置いて穴をふさぐ。

　　　PMXeの簡易プリミティブ追加などで箱ポリゴンを作って配置。
　　　VoxelPackRT以外のタブで表示チェックを外す。

　・光が当たっているはずなのに暗い。
　　光の計算がどこかで間違っているため？
　　自分自身または周囲のボクセルに遮られたことになっている場合があります。

　　対策：
　　　標準ライトの明るさをデフォルトの157より大きくする。
　　　PPointLightを補助光源として配置する。

画像出力すると画質が落ちている気がする。
　複数フレームにわたって光源計算をしているため、1フレームだけ出力する画像出力では、
　計算が不完全になります。

　対策：
　　5フレーム程度の動画を出力して、動画編集ソフトで最後のフレームを切り出す。

動画出力の先頭フレームが明るい/暗い。
　複数フレームにわたって光源計算をして、その結果を利用しているためです。

　対策：
　　先頭数フレームに余白を作って動画出力し、あとで不要な部分をカットする。
　　あるいは、先頭数フレームにフェードインを追加するなどしてごまかす。

残像が残る。
　複数フレームにわたって光源計算をしているため。
　例えば、ライトを消しても数フレームの間、消したライトの影響が残る場合があります。

広いステージには向かない。
　ボクセル化範囲が狭いため、光源計算を行える範囲が狭いです。
　デフォルトできしめんステージの横幅程度の範囲しかサポートしていません。

　対策：
　　アクセサリのSiでボクセルのサイズを調整することは可能です。

オープンスペースには向かない。
　光の反射を計算するエフェクトなので、光を反射したり遮蔽したりする対象が
　少ないステージでは使用するメリットが少ないです。


■ 使用方法

1. MMDにikVXGIを入れる。

2. Mainタブにエフェクトを設定する。
　Mainタブで、モデルやステージなどに Main/VxMain.fxを割り当てる。
　※ スカイドームには割り当てない。

3. 環境マップ用の設定をする。
　EnvMapRTタブで スカイドームにTEnvMap_emissive.fxを割り当てる。

　背景モデルが.pmxモデルの場合、TEnvMap.fxを割り当てる。
　キャラモデルには割り当てないほうがよいため、
　デフォルトで、.pmxは環境マップの描画対象外にしています。


以下は、必要に応じて設定する項目：
4. 常に光っているモデル(材質)には、VoxelPackRTタブで Voxelize_emissive.fx を割り当てる。
　※ AL対応モデルは Voxelize.fx が自動で発光させます。

5. 材質毎の設定を行う。
　MaterialMapRT タブでモデルの材質に合わせたエフェクトファイルを割り当てる。


■ カスタマイズ

アクセサリの中心座標
　ボクセル化する中心位置。
　頻繁に動かすとチラつきの原因になります。

　※ ikPolishと異なり、環境マップはアクセサリの中心座標+(0,15,0)としているので、
　地面の高さが0の場合、初期位置から上に移動させる必要はありません。
　オフセット量はsettings.fxsubで指定可能です。

アクセサリのSi
　1ボクセルのサイズを変更する。
　ボクセルサイズはデフォルトで4.0MMD単位(約50cm)
　ステージが広い場合、大きな値にする。大きい値ほど計算精度が悪くなります。

settings.fxsub
　設定ファイル。ファイル内のコメントを参照してください。

ikVXGI.fx
　先頭に設定項目がいくつかあります。
　TEST_DISPLAY_VOXELS を有効にすることで、ボクセルを確認することができます。


■ 材質ファイル

※ ikPolishと考え方は似ていますが、直接の互換性は無ありません。

□ 基本的な設定

Metalness (0.0〜1.0)
　正面での反射率を表す。金属なら0.5〜1、非金属なら0.05にする。
　銀で0.95、鉄で0.55、宝石で0.1〜0.2程度。
　※ ikPolishのNonmetalF0に当たる。

Smoothness (0.0〜1.0)
　表面の滑らかさ。0でマット。1でツルツル。

　ENABLE_AUTO_SMOOTHNESS が有効な場合、
　モデルに設定されたスペキュラパワー(反射強度)値から素材の滑らかさを推測します。

Intensity (0.0〜1.0)
　映り込み強度。0で映り込まない。1で映り込む。
　Smoothnessの値を下げると、自動で映り込みの強さが減少します。

SSSValue (0.0〜1.0)
　皮下散乱度：肌などの半透明なものに指定。0:不透明。1:半透明。
　大きな値ほど、陰影計算の結果をボカします。


■ 追加ライト

PPointLight1.x〜PPointLight4.xは追加用のポイントライトです。
同名のアクセサリは同時に1つだけしか有効になりません。

アクセサリの座標でライトの中心位置を指定。
RX,RY,RZで色を指定。(10,10,10)で大体MMD標準ライトの(1,1,1)に相当する。
Siで影響範囲を指定。
Trで光の強さを指定。


■ 使用、再配布に関して

エフェクトの利用、改造、再配布などについては自由に行ってもらってかまいません。
連絡も不要です。
このエフェクトを使用したことによって起きたすべての損害等について、
作者及び関係者は一切責任を負わないものとします。


■ 更新履歴

　2016/09/10 Ver 0.02a　・MMD 32bit版で動作するようにした。
　2016/08/16 Ver 0.02　・計算方法の見直し。但し根本的な問題は解決せず。
　2016/08/07 Ver 0.01　・初公開


ikeno
Twitter: @ikeno_mmd
