
ikBokeh (ikボケ)

■ 概要

ikBokehは、ポストエフェクトによって、カメラのピントを擬似的に表現するエフェクトです。
動作はそこそこ重いです。


■ 使用方法

1. MMDのアクセサリに、"ikBokeh.x"を追加する。
2. アクセサリの描画順序を調整する。
　基本的には、モデル、パーティクルなど(カメラの先にあるもの)よりは後に、
　レンズフレアやトーンマップなど(カメラ内、撮影後の加工エフェクト)より前にします。

3. ikBokeh.x をピントを合わせたいモデルの頭ボーンにぶら下げる。
　(または、ダミーボーンにぶら下げて、ダミーボーンの位置でピントを調整する。)

4. ikBokehController.pmx を追加する。(細かい調整をしない場合は不要)
5. ikBokehController.pmxの各種パラメータを設定する。


■ パラメータの詳細

□ コントローラから設定できるパラメータ

　ピント距離+
　ピント距離-
　　ピントの位置を補正します。0〜1で+-50MMD単位調整します。
　　なお、コントローラのzを前後させることでも調整可能です。

　　ピントが合っていない状態から、ピントを合わせる。
　　またはその逆などの演出を行いたい場合に使用します。

　　ikBokeh.xをキャラの頭ボーンにぶら下げた場合、多少ピント距離をマイナスしたほうがよいです。
　　補正しない場合、頭の中心にピントが合うため、中心より手前にある顔は若干ピント範囲からズレるためです。

　ピント遅延
　　ピントの追従速度を遅らせます。1で完全に停止します。
　ピント安定度
　　ピントの移動を安定させます。

　　ピント安定度が低いとピント調整にブレが出ます。
　　ピントを動かし過ぎて元に戻す演出を行いたい場合は、安定度を下げます。

　　ピントの遅れを出したくない場合は両方を0にします。
　　遅れを出したい場合は両方を0.8あたりに設定してから調整してみてください。

　測距点x+/x-/y+/y-
　　AF測距モードで測距点基準でピントを合わせるモードにした場合の、
　　ピント計測位置の中心を指定します。
　　なお、コントローラのxyでも調整可能です。

　　テストモードで黄色い丸で表示されるのが、測距点の位置になります。


　ボケ+
　ボケ-
　　ボケる幅を調整します。

　前ボケ-
　　前ボケの大きさを調整します。


　CoCサイズ
　　ボケの大きさを調整します。0で等倍。1で2倍になります。
　　CoCとはCircle of Confusion(錯乱円)の略で、いわゆる玉ボケのことです。
　　アクセサリのSiからも調整可能です。

　玉ボケ強調
　　明るい部分の色を強調する。
　　玉ボケDOF(Elle/データP)から処理を借用しました。


　テストモード
　　前ボケ、後ボケの範囲を色つきで表示します。

　　緑：後ボケ (ピントが合う位置よりも後ろにある)
　　白：ピントが合っている。
　　青：完全にピントが合っている。(ジャスピン)
　　紫：前ボケ (ピントが合う位置よりも手前にある)
　　黄：AF測距モードが有効なときの測距範囲。


　AF測距モード
　　0.0でアクセサリ位置にピントを合わせる。
　　0.5で測距点(狭)の位置にピントを合わせる。
　　1.0で測距点(広)の位置にピントを合わせる。

　マニュアルモード
　　1でマニュアルモード有効

　以下は、マニュアルモードが有効な場合の設定。

　ピント距離
　　マニュアルモードが有効な場合のピント位置。
　　0〜1で0〜100MMD単位の位置にピントが合います。
　　ピント距離+、-と併用可能です。
　　* マニュアルモード無効時は指定したモデル・ボーンにピントが合う。

　焦点距離
　　マニュアルモードが有効な場合の焦点距離を設定します。
　　0〜1で0〜100mmの設定になります。大きい数値ほど、ボケやすくなります。
　　ボケ+、-の影響を受けます。
　　* マニュアルモード無効時は画角に応じて自動調整される。


□ エフェクトファイル上で直接操作するパラメータ

ikBokeh.fx

　FORCE_COC_SCALE (コントローラの"CoCサイズ"と同機能)
　　ボケのサイズを強制的に拡大する拡大率。
　　デフォルトは1(等倍)

　FRONT_BOKEH_SCALE (コントローラの"前ボケ-"と同機能)
　　前ボケのボケ量調整

　AF_MODEL_NAME
　AF_BONE_NAME
　　オートフォーカス時に追いかける対象。
　　デフォルトはikBokeh本体になっています。

　USE_MME_32BIT
　　32bit版のMMEを使用している場合1を設定する。
　　64bit版では0を設定したほうが若干高速になる。
　　32bit版で0を設定すると画像が腐る。


■ ボカすために

　カメラと被写体の距離が近いほど、被写界深度(ピントが合う範囲)は浅くなります。
　背景をボカしたい場合は、撮りたい対象にカメラを近づけましょう。
　逆にボカしたくない場合は、被写体からカメラを離しましょう。

　ピントが合う範囲から外れるほどボケます。
　ボカしたい対象をよりカメラから離す(後ボケ)。または、ボカしたい対象をよりカメラに近づける(前ボケ)。

　カメラと被写体の距離が変わると構図が変わります。画角を変更することで調整できる場合があります。

　背景のコントラストを高くする。小物を置くなどして無地にしない。
　背景に変化がないとボケたのが分かりにくいです。

　カメラやモデルの位置を弄りたくない場合は、ikBokehController.pmxで調整してください。
　主に左下の「まゆ」モーフがボケ度合いに関連するパラメータになります。
　これは実際のカメラで絞りを調整することにあたります。



■ 既知の問題

　半透明な素材のうしろにあるものがボケない。
　後に透けて見えるものも、半透明素材の距離でボケる量を決定するためです。

　エフェクトによって写り込んだ遠くのモデルが、反射された手前の距離でボケかされる。
　例：ボケた背景がピントのあった手前の床に写り込んでいる場合、床に合わせてピントが合った状態で表示される。

　手前にあるはずのパーティクルなどのエフェクトが遠くにあるかのようにボケる。
　パーティクル側と連携して個別に対応する必要があります。

　動画作成時と編集作業時でボケ方が変わる。
　画面サイズに応じてボカしているためにこうなっています。


■ 使用、再配布に関して

　エフェクトの利用、改造などについては自由に行ってもらってかまいません、連絡も不要です。
　このエフェクトを使用したことによって起きたすべての損害等について、作者及び関係者は一切責任を負わないものとします。



■ 更新履歴

　2017/02/25 Ver 0.17
　　前ボケサイズの軽減機能追加。
　　パラメータの調整。
　　高速化。コードの整理。
　　v0.14で入れたジャギ軽減機能を削除

　2016/10/29 Ver 0.16　　高速化。処理の修正。玉ボケの強調機能を追加。
　2016/06/22 Ver 0.15　　バグ修正
　2016/04/27 Ver 0.14　　ジャギ軽減機能を追加
　2016/01/30 Ver 0.13　　コントローラ位置でピントの微調整を行えるようにした。ikボケからikBokehに改名。
　2015/12/20 Ver 0.12　　ピントの遅れ、測距モードの追加。
　2015/09/14 Ver 0.11　　テストモードの不具合を修正。
　2015/08/30 Ver 0.10　　最適化。コードの整理。

　2015/05/31 Ver 0.09
　　ピント付近のジャギが目立っていたのを解消。
　　錯乱円の大きさを調整できるようにした。

　2015/04/12 Ver 0.08
　　高速化のために処理の全面見直し。
　　オートフォーカスモードをメインにして、設定を簡易化した。
　　テストモードでのジャスピン位置を青表示するようにした。

　2015/01/21 Ver 0.07
　　コントローラ対応
　　AF処理の見直し。
　　出力サイズによるボケの掛かり具合を調整

　2014/11/09 Ver 0.06　　32bit対応
　2014/11/07 Ver 0.05　　自動フォーカス機能の追加
　2014/11/05 Ver 0.04　　バグの修正と微調整
　2014/10/26 Ver 0.03　　全面的に改造
　2014/09/04 Ver 0.02　　ファイル名とreadme.txtの誤字修正
　2014/08/28 Ver 0.01　　初公開


ikeno
twitter: @ikeno_mmd

