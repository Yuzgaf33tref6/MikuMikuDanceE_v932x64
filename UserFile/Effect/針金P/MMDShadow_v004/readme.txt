MMDShadow.fx ver0.0.4

MMD標準のセルフシャドウと同等の機能をエフェクトのみで実装した影生成エフェクト。
作成されるシャドウマップはMMD標準のものとほぼ同じです。
MMDのシャドウマップとの相違点は
  ①モデルのセルフ影選択がOFFの時もシャドウマップ描画を行う。よってセルフ影OFFモデルが
    他のセルフ影ONモデルに落とす影は描画されます。
  ②テクスチャのα値を考慮。セルフ影のテクスチャ透過に対応しています。
  ③VSM法によるソフトシャドウにも対応(OFFにするとMMDのセルフ影とほぼ同じになる)。
ソフトシャドウについてはクオリティ、描画速度ともにfull_SimpleSoftShadow(ビームマンP)と
のExcellentShadow(そぼろ)の中間的な位置づけになっています。
また、100%エフェクトで処理しているため、MMDとMikuMikuMovingで全く同じセルフ影操作・影生成ができます。
ソフトシャドウOFF設定にするとMikuMikuMovingでMMD標準描画とほぼ同じ結果を得ることが出来ます。


・動作環境
SM3.0対応グラフィックボードが必須になります。
MMEv0.37, MMEv0.37x64，MMMv125a，MMM64v125aで動作確認を行っています。旧バージョンでは動作しない可能性があります。


・使用方法
(1)MMDShadow.xをMMDにロードしてください。MMMではMMDShadow.fxを直接ロードします。
(2)MMDShadow.xの描画順序を出来るだけ前の方にしてください。MMMではMMDShadow.xより前の順序のモデルは正常に描画されません。
(3)描画するすべてのモデル・アクセサリに以下のエフェクトファイルを適用します。
  MMEの場合
    ｢MMEffect｣→｢エフェクト割当｣のMainタブより描画するすべてのモデル・アクセサリを選択して full_MMDShadow.fx を適用します。
  MMMの場合
    SampleBase_MMDShadow.fxm または full_MMM.fxm をMMMにロードして、メインの｢エフェクト割り当て｣より全モデル・アクセサリに適用。
    (対応しているのはライト1のみ、ライト2,ライト3は標準の影が描画されます。full_MMM.fxmはライト1のみで複数ライトは未対応です。)
(4)MMD/MMMの全体のセルフ影設定はONにして下さい。
(5)MMDの｢セルフ影操作｣パネルより標準のセルフシャドウと同じ操作・設定が行えます。
   MMMではMMDShadow.fxのエフェクトプロパティより同様の操作・設定が行えます。
(6)MMDShadow.xのアクセサリパラメータで以下の操作が可能です。
    Si：ソフトシャドウによる影のぼかし度
    X,Tr：影の濃度変更( (X+1)*Tr が設定濃度になります )
   MMMではMMDShadow.fxのエフェクトプロパティより同様の操作・設定が行えます。
(7)必要に応じて MMDShadow_Header.fxh の先頭パラメータを変更してください。
   特に UseSoftShadow を 0 にするとソフトシャドウが出来なくなる代わりにMMD標準のセルフシャドウと
   ほとんど同じ結果を得ることが出来ます。


・PMD・PMXの組み込みコントロールモーフについて
影生成するモデルがPMD・PMXの場合はモデルにコントロール用のダミーモーフを追加することで、モデル毎に個別の
調整が出来るようになります。対応しているモーフ名は以下の通りです。

   ShadowBlur+ : モデルの影のぼかし度を上げます
   ShadowBlur- : モデルの影のぼかし度を下げます
   ShadowDen+  : モデルの影の濃度を上げます
   ShadowDen-  : モデルの影の濃度を下げます

   ※同梱のPMDEスクリプト｢コントロールモーフ追加.cx｣を使って,これらのモーフを一括追加することが出来ます。


・各シェーダエフェクトの種類について
   full_MMDShadow.fx        : 舞力介入Pの full.fx を本エフェクトに対応させるため改変、MME専用
   SampleBase_MMDShadow.fxm : Mogg氏の SampleBase.fxm を本エフェクトに対応させるため改変、MMM専用
   full_MMM.fxm             : 舞力介入Pの full.fx をMMMで使用出来るように改変、MMD標準描画とほぼ同じ結果になる。MMM専用


・他のシェーダエフェクトの改変方法
  既存のシェーダエフェクトに対応させるには、シェーダエフェクトファイルの変更が必要になります。
   ①MMDShadow_Header.fxhをシェーダエフェクトのフォルダにコピーします。先頭パラメータは本体のものと同じにしてください。
   ②full_MMDShadow.fx,SampleBase_MMDShadow.fxmの改変箇所と同じ変更を各シェーダエフェクトで行います。
     変更箇所についてはfull_MMDShadow.fx,SampleBase_MMDShadow.fxmのコメントに書いてあるので参考にしてください。


・PMXのシャドウマップOFF材質の対応
  現状ではPMXのシャドウマップOFF材質をエフェクト側で知る方法がないので全材質についてシャドウマップ描画を行っています。
  PMXのシャドウマップOFFの材質についてはサブセット展開して材質を非表示設定にするか、以下の方法で対応します。
    ①MMDShadow_SMapPMX.fx の先頭パラメータでPMXの材質でシャドウマップOFFの材質番号をリストアップする
    ②オフスクリーンタブのMMD_ShadoeMapより指定のPMXモデルを選択してMMDShadow_SMapPMX.fxを適用。


・MMDのシャドウマップ情報について
  MMDShadow_Header.fxh のコメントにMMD標準シャドウマップの蘊蓄について詳しく書いておきましたので興味のある方は御覧下さい。
  (あくまで独自の解析よるものなので内容の正確さを保証するものではありません)


・更新履歴
v0.0.4  2014/7/5   コントロールモーフによるモデル毎の個別調整が出来る機能追加
                   影濃度の計算方法を一部修正
v0.0.3  2014/6/30  シェーダエフェクトコードを改変時に簡便に出来るように整理した。
                   影濃度を濃くできるようにした。
v0.0.2  2014/5/5   加算合成ONモデルのシャドウマップ描画を行わないようにした(MMD標準と同じ)。
v0.0.1  2014/4/7   初回版公開


・免責事項
ご利用・改変・二次配布は自由にやっていただいてかまいません。連絡も不要です。
ただしこれらの行為は全て自己責任でやってください。
このプログラム使用により、いかなる損害が生じた場合でも当方は一切の責任を負いません。


by 針金P
Twitter : @HariganeP


