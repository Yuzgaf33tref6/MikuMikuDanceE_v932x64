Flocking.fx ver0.0.8

フロッキングアルゴリズムを使って複製モデルの群れの行動のシミュレーションを行います．
障害物回避，リーダー追従機能を使ってある程度群れの行動を制御できるようになっています．
また最大4種類まで別々の群れを設定できるバージョンも作成しました．
以下の説明では群れの行動する複製モデルを｢ユニット｣と呼び，他のモデルと区別します．


・基本的な使用方法
１．単体ユニットバージョン
(1)Flocking.xをMMDにロードします．MMMではFlocking.fxを直接ロードしてください．
(2)群れ行動制御するモデルにFlocking_Obj.fx(MMMではFlocking_Obj.fxm)を適用します．
(3)Flocking.fx,Flocking_Obj.fxの先頭パラメータを適宜変更してください．
(4)0フレームを再生する．
     サンプルとして魚群モデルfish[Flocking_obj.fx].xを同梱してありますので，まずはこちらで試してみてください．

２．多種類ユニットバージョン（｢多種類ユニット｣フォルダ内のファイル使用）
(1)Flocking_Multi.xをMMDにロードします．MMMではFlocking_Multi.fxを直接ロードしてください．
(2)群れ行動制御するモデルにFlocking_Obj*.fx(MMMではFlocking_Obj*.fxm)を適用します．(*は1～4)
(3)Flocking_Multi.fx,Flocking_Obj*.fxの先頭パラメータを適宜変更してください．種類ごとに個別の群れ行動設定が可能です．
(4)0フレームを再生する．
     サンプルとして魚群モデルfish[Flocking_Obj*.fx].xを同梱してありますので，まずはこちらで試してみてください．


・障害物回避（｢障害物回避｣フォルダ内のファイル使用）
障害物調整用モデルとしてアクセサリとPMDがあります．アクセサリは主にモデルのボーンに付けてモデルをカバーして
ユニットとの衝突回避に使用します．PMDは遮蔽壁としてユニットの行く手を遮り，ユニットの行動範囲を制御します．
１．アクセサリ(Flocking_Obstacle_*.x)の場合
(1)Flocking_Obstacle_*.xをMMDにロードします(*はそれぞれBall:球，Capsule:カプセル，Cube:立方体)．
   MMMではFlocking_Obstacle_*.fxを直接ロードしてください．
   ユニットが調整モデルの表面に近づき衝突の可能性がある場合はユニットが回避行動をとります．
(2)ロードした調整モデルを衝突回避させたいモデルのボーン(通常はセンターボーンでOK)に付け，アクセサリパラメータを
   調整して，ほどよくモデル全体をカバーします．
(3)ユニットが正常に回避できる状態を確認したら，アクセサリパラメータをTr=0にして調整モデルを非表示にして使用します．
   これでユニットがモデルに近づくと回避行動をとります．

２．PMD(Flocking_Obstacle_Wall.pmd)の場合
(1)Flocking_Obstacle_Wall.pmdをMMDにロードします．
   MMMではFlocking_Obstacle_Wall.fxもロードしてFlocking_Obstacle_Wall.pmdに適用してください．
(2)表情スライダでモデルの大きさを調整して，ユニットを遮断したい位置に置きます．
   これでユニットがモデルの壁に近づくと回避行動をとります．
(3)ユニットが正常に回避出来たら，表情スライダの｢透明｣でモデルを非表示で使用します．


・リーダー追従
(1)Flocking_Leader.xをMMDにロードします．MMMではFlocking_Leader.fxを直接ロードしてください．
(2)ユニットがアクセサリモデルの内部に入るとモデルの中心部に引き寄せられます．Siで影響範囲を調整できます．
(3)Flocking_Leader.xを適当なボーンに付けて動かすと，引き寄せられたユニットが追従するようになります．
(4)調整が済んだらアクセサリパラメータをTr=0にしてアクセサリを非表示で使用します．
     多種類ユニットバージョンの場合はFlocking_Leader1.x～Flocking_Leader4.xを使用してください．グループ別に追従させることが出来ます．


・AutoLuminous対応モデルについて
オプションとしてAutoLuminous2.0(そぼろ氏作)用のセレクタを作成しましたのでAL_Optionフォルダにある
対応するセレクタファイルをユニットモデルに適用してください．
・AutoLuminous対応モデルの場合：｢MMEffect｣→｢エフェクト割当｣のAL_EmitterRTタブからユニットモデルを指定して、AL_Selector_FlockingObj.fxを割り当てる．
・ObjectLuminous方式の場合：｢MMEffect｣→｢エフェクト割当｣のAL_EmitterRTタブからユニットモデルを指定して、OL_Selector_FlockingObj.fxを割り当てる．
                            こちらはObjectLuminous,CrossLuminousでも使用可です.fx内パラメータは必要に応じて変更してください．
・AutoLuminousのマスク機能を使う場合：｢MMEffect｣→｢エフェクト割当｣のAL_MaskRTタブからユニットモデルを指定して、AL_Mask_FlockingObj.fxを割り当てる．
(詳しい使用方法はAutoLuminous,ObjectLuminousのReadme.txt参照)．
これらの発光エフェクトと併用する場合は、ユニットモデルの描画順序をFlocking.xよりも前に設定してください．でないとモデルと発光描画の位置が
ずれることがあります．


・その他の操作
(1)パラメータ変更によるFXファイル更新時は急激な加速度が掛かり，うまく表示されなくなることがあります．
   その場合，0フレームを再生するとデータが初期化されて再表示されるようになります．
(2)逆に0フレームを再生しない限り群れの配置は初期化されません．AVI出力時に任意の配置からスタートしたい場合は
   開始フレームを1にしてください．またはFlocking.xでTr=0にすると0フレーム再生での初期化をキャンセル出来ますので
   必要に応じて使い分けてください．
(3)Flocking.x,Flocking_Multi.xでアクセサリパラメータSiを変更するとデフォルトの移動範囲を拡大・縮小することが出来ます．
(4)初期配置を変更したい場合は配置情報を記録した画像ファイル(ArrangeData.png)を拙作TexTableEditで新たに作成します．
     TexTableEdit DL先：http://harigane.at.webry.info/201003/article_3.html
     作成方法：①TexTableEditを起動したら｢編集｣→｢行列数設定｣で8列×1024行にしてください．
               ②各列に入れるデータはそれぞれ以下の通り
                  1列目：ユニットx座標
                  2列目：ユニットy座標
                  3列目：ユニットz座標
                  4列目：ユニットx軸回転(°)
                  5列目：ユニットy軸回転(°)
                  6列目：ユニットz軸回転(°)(現時点では未使用)
                  7列目：ユニットスケール比
                  8列目：未使用
               ③入力がすんだらPNG形式の画像ファイルに保存して、ファイル名をFlocking.fxの先頭パラメータで指定します．
               ④同梱のArrangeData.pngをTexTableEditにロードすれば参考になると思います．


・注意点
※このFXファイルをMMEで使用するにはVTF(Vertex Texture Fetch)対応のSM3.0グラフィックボードが必須になります．
また、MME ver0.24以降でないと正しく動作しません。
多種類ユニットバージョンはグラボによっては正常に動作しない可能性があるかも・・・

(↓MMD･MME版のみ、MikuMikuMoving版ではこの項目は不要です)
複製モデルがPMDの場合エッジは独自描画になります．デフォルトでは全ての頂点に対してエッジ描画するようになっています．
PMDの材質でエッジoff設定にしているところまでエッジを描くので，正確に描画するにはモデルごとにエッジの材質指定をする必要があります．
PMDEditorでエッジを描画している材質を確認してからFlocking_Obj.fx,Flocking_Obj*.fxの先頭パラメータで描画する材質を指定してください．
材質指定方法は以下のように記述します．<MMEffectのREFERENCE.txtより抜粋>
　　"0,3,5"のように、カンマ区切りで番号を列挙することで、複数の番号を指定できる。
　　また、"6-10"などのように、番号をハイフンでつなぐことで、範囲指定ができる。
　　"12-"のように、範囲の開始番号のみを指定した場合は、それ以降の全ての番号が対象となる。


・更新履歴
v0.0.8   2013/06/29   MMEシェーダを新しいバージョン(v0.33以降)仕様にした(PMXの材質モーフ､サブTex等に対応)
                      MikuMikuMoving版の動的パース対応など,その他細かい変更・修正
v0.0.7   2012/12/04   アルゴリズムの改良,MikuMikuMovingの対応,その他細かい変更・修正
v0.0.6   2012/09/10   x64版の対応,ユニット配置方法を一部変更
                      障害物回避のバグ修正,AutoLuminous2.0用セレクタ追加
v0.0.5   2011/10/03   細かい修正,ObjectLuminous用セレクタ追加
v0.0.4   2011/07/01   スフィアマップ使用材質でα値が正しく描画できない不具合を修正
v0.0.3   2011/04/17   障害物回避，リーダー追従，多種類ユニット制御追加．その他いろいろ変更・修正
試作版2  2011/03/24   アルゴリズムに関するバグの修正
試作版   2011/03/22   初回版公開


・免責事項
ご利用・改変・二次配布は自由にやっていただいてかまいません。連絡も不要です。
ただしこれらの行為は全て自己責任でやってください。
このプログラム使用により、いかなる損害が生じた場合でも当方は一切の責任を負いません。


by 針金P
Twitter : @HariganeP


