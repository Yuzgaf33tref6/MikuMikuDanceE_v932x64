VolumeShadow.fx ver0.0.2

シャドウボリューム法による影生成エフェクトです。
現在標準的に使われているシャドウマップ法と異なり、マップの解像度や描画範囲・カメラ操作の
影響を受けず、エイリアシング(影境界のギザギザ)が発生しないシャープな影生成を行うことが出来ます。
ただし、シャドウボリューム作成のためのモデル改造が必要で頂点数が大幅に増えて
処理が重くなるという問題はあります。また、テクスチャ透過による影は原理的に行えません。



・動作環境
SM3.0対応、両面ステンシル処理対応のグラフィックボードが必須になります。
MMEv0.37, MMEv0.37x64で動作確認を行っています。旧バージョンでは動作しない可能性があります。

※このエフェクトは MikuMikuMoving には対応していません(多分MMMの動作機構では処理不可能?)



・モデル変換方法
このエフェクトを使用するには、シャドウボリューム作成のためのモデル改造が必須になります。
前準備として影生成を行うモデルをPMDEスクリプトでデータ変換してください。
スクリプトはPMDEditor v0.1.3.9、 PmxEditor v0.2.2.1にて動作確認しております。
旧バージョンでは正常に動作しない可能性があります。

(1) PMD・PMXの場合
  ①PMDEditorまたはPmxEditorを起動します。
  ②影生成するモデルを読み込みます。
    PMDEditorでPMDをロードした時は｢情報｣→｢PMX編集へ切り替え｣でPMXモードに切り替えてください。
  ③｢編集｣→｢プラグイン｣→｢CSScript｣でC#スクリプトを開く
  ④同梱の「モデル変換スクリプト.cx」を読み込む(CSScriptウィンドウにD&DでOK)
  ⑤｢一般形式｣タブの方にして｢実行｣ボタンを押す→シャドウボリューム作成に必要な頂点・面・材質が追加されます。
    ※モデルの変換処理には時間がかかります。実行環境にもよりますが、モデルデータ量が大きい場合
      10分以上かかることも予想されます。その間PMDEがフリーズ状態になりますが気長にお待ちください。
      材質リスト先頭に｢セルフ影作成｣が追加されたら変換完了です。材質の位置は先頭から変更しないでください。
      モデル変換後は頂点・面ともに約10倍の重量級モデルに変身しますが、そういう仕様ですので・・
    ※特殊な面構造をしたモデルや、不正な頂点・面があるモデルでは正常な変換が出来ない場合があります。
  ⑥変換したモデルをPMX形式でモデル出力してください。

(2) アクセサリの場合
  ①PMDEditorまたはPmxEditorを起動します。
    PMDEditorでPMDモードの時は｢情報｣→｢PMX編集へ切り替え｣でPMXモードに切り替えてください。
  ②影生成するアクセサリを読み込みます。
  ③｢材質｣リストよりシャドウボリュームを作成する材質を選択して｢セルフ影マップ｣をONにします。
  ④PMD・PMXの③～⑤と同様の方法でスクリプトを実行します。
  ⑤変換したモデルを｢ファイル｣→｢エクスポート｣よりXファイル形式で出力してください。

※シャドウボリュームはセルフ影マップONの材質に対して作成されます。また、本来はメッシュ構造が閉じていないと
  正しいシャドウボリュームを形成出来ないのですが、ほとんどのMMDモデルはそうなっていないため、スクリプトでは
  ポリゴンの両面に対してシャドウボリューム構築することで対処しています(そのため通常の倍近い頂点が必要)。
※建物モデルの天井やスカイドームにシャドウボリュームを作ると内部は全て影部になってしまうので、これらは
  材質でセルフ影マップOFFにしてモデル変換することをオススメします。
※描画する全てのモデルを変換すると相当なデータ量になるため、かなり重くなります。
  後述の通りMMD標準セルフシャドウやHgShadowとの供用が可能ですので必要なモデルのみ変換してください。



・エフェクト使用方法
(0) ※32bit版MMEをご利用の場合はデフォルト状態では多分エラーになるので、
      VolumeShadow.fx 先頭パラメータを UseMLAA  1 → UseMLAA  0 に変更してください。
      64bit版ではこの行程は不要です。
(1)VolumeShadow.xをMMDにロードしてください。
(2)MMDの全体のセルフ影設定はONにして下さい。
(3)描画するすべてのモデル・アクセサリに以下のエフェクトファイルを適用します。
  ｢MMEffect｣→｢エフェクト割当｣のMainタブより
    ①シャドウボリュームを作成したモデル ・アクセサリを選択して full_VolumeShadow.fx を適用します。
    ②その他の通常モデル・アクセサリを選択して full_WithoutSV.fx を適用します。

  ※このエフェクトではシャドウボリュームの影とMMD標準のセルフシャドウを供用することが出来ます。
    上記の設定を行うと ①変換モデルに通常モデルのMMD標準影を落とす、②通常モデルに変換モデルの
    ボリューム影を落とす といった相互利用が可能になっています。
    またこのエフェクトは拙作HgShadowとの供用も可能になっています。使用方法についてはHgShadowの
    readme.txtを参照ください。

(4)VolumeShadow.xのアクセサリパラメータで以下の操作が可能です。
    X : シャドウボリュームの引き延ばし補正値
        (1000+X が引き延ばす長さになります。遠くに影が落ちない時はここを上げて調整)
    Si：影の濃度変更
    Tr：影境界を少しぼかす(ジャギーを目立たなくするのが目的です。
        デフォルトではMLAAによるアンチエイリアスが効いているのでOFF設定の時に使ってください)。
(5)必要に応じて VolumeShadow.fx の先頭パラメータを変更してください。



・PMD・PMXの組み込みコントロールモーフについて
  モデル変換スクリプトを実行するとシャドウボリュームと共ににコントロール用のダミーモーフが追加されます。
  このモーフでモデル毎に個別の調整が出来るようになります。対応しているモーフ名は以下の通りです。

    ShadowBlur+ : モデルの影のぼかし度を上げます(本エフェクトでは使用しません。HgShadowと供用する時に使用します。)
    ShadowBlur- : モデルの影のぼかし度を下げます(本エフェクトでは使用しません。HgShadowと供用する時に使用します。)
    ShadowDen+  : モデルの影の濃度を上げます
    ShadowDen-  : モデルの影の濃度を下げます



・他のシェーダエフェクトの改変方法
  既存のシェーダエフェクトに対応させるには、シェーダエフェクトファイルの変更が必要になります。
   ①VolumeShadowHeader.fxh をシェーダエフェクトのフォルダにコピーします。
   ②full_VolumeShadow.fx, full_WithoutSV.fx の改変箇所と同じ変更を各シェーダエフェクトで行います。
     変更箇所については full_VolumeShadow.fx, full_WithoutSV.fx のコメントに書いてあるので参考にしてください。



・技術情報
本エフェクト作成にあたり以下のサイトを参考にさせていただきました。
http://program-tips.com/shadow-volume/
http://t-pot.com/program/75_shadow2Vol/index.html



・更新履歴
v0.0.2  2014/7/5    コントロールモーフによるモデル毎の個別調整が出来る機能追加
                    影濃度の計算方法を一部修正
v0.0.1  2014/6/30   初回版公開


・免責事項
ご利用・改変・二次配布は自由にやっていただいてかまいません。連絡も不要です。
ただしこれらの行為は全て自己責任でやってください。
このプログラム使用により、いかなる損害が生じた場合でも当方は一切の責任を負いません。


by 針金P
Twitter : @HariganeP


